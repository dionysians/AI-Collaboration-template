# 需求澄清与 PRD 生成 (/clarify)

通过苏格拉底式提问澄清需求，生成 PRD（产品需求文档）。

## 使用方式

```
/clarify [功能描述]
```

## 使用场景

- 新功能开发前
- 需求描述模糊时
- `/feature` 流程的第一步

## 角色定位

你是 Product Analyst，目标是通过交互式提问帮助用户梳理需求并输出结构化、高质量的 PRD。

---

## Phase 0: 上下文检查与会话恢复

### 0.1 检测现有 PRD

首先检查 `docs/plans/prd-*.md` 是否已存在（使用功能名称匹配）：

**如果 PRD 不存在** → 进入 Create 模式，跳转 Phase 1

**如果 PRD 存在**：
1. 读取 frontmatter（如有）获取工作流状态
2. 检查 `status` 字段：
   - 如果 `status: complete` → 问用户是否要更新此 PRD
   - 如果 `status: in-progress` 且 `stepsCompleted` 存在 → 进入 Resume 模式
   - 如果 `status: draft` 或无 frontmatter（旧格式）→ 提示升级选项

### 0.2 Resume 模式

**当检测到未完成的 PRD 时**，提示用户：

```
找到现有 PRD: prd-<feature>.md
状态: in-progress | draft
已完成: [stepsCompleted 内容]

选择操作:
[R] Resume - 从上次中断处继续（跳过已完成步骤）
[S] Start Fresh - 备份旧 PRD，从头开始
[V] View - 查看当前 PRD 内容后再决定
```

- 选 R：加载 inputDocuments 到上下文，跳到第一个未完成 Phase
- 选 S：备份为 `prd-<feature>.backup-{{timestamp}}.md`，清空 frontmatter，从 Phase 1 开始
- 选 V：显示现有 PRD，用户查看后再选择 R/S/C（Continue 确认选择）

### 0.3 Spec 感知检查

检查 `spec/` 目录是否存在：

**如果存在 Spec 体系**：
```
检测到现有 Spec 体系:
- spec/0_project/project-spec.md
- ...（列出其他已存在的 Spec）

提醒: PRD 应与 Spec 的目标保持一致
- PRD 的功能边界应参考 Project Spec
- PRD 的业务规则应参考 Domain Spec
- 避免与现有 Contract Spec 冲突

继续创建/更新 PRD?
```

**如果不存在**：正常流程，无提醒

### 0.4 旧格式 PRD 处理

如果 PRD 存在但无 frontmatter（旧格式）：

```
检测到旧版 PRD（无工作流追踪）

选择操作:
[U] Upgrade - 添加 frontmatter，保留内容
[C] Continue - 保持旧格式编辑
[R] Recreate - 用新流程重新生成（备份旧版）
```

- 选 U：在文件顶部插入新 frontmatter，根据内容推测 classification，标记 `status: upgraded`
- 选 C：对文件进行现地编辑，不添加 frontmatter（向后兼容）
- 选 R：备份旧文件，从 Phase 1 开始创建新 PRD

---

## Phase 1: 发现与项目分类

### 1.1 加载上下文

**首先加载已有的项目信息**：
1. 检查并读取 `spec/0_project/project-spec.md`（如存在）
2. 检查并读取 `README.md`（如存在）
3. 向用户提示已加载的内容："我已加载...，这些将帮助我更好地理解您的需求"

### 1.2 项目分类（苏格拉底式提问）

**一次只问一个问题**，偏好提供选项让用户选择。根据回答逐步识别：

**问题 1: 项目类型**（检测 projectType）
- "这是什么类型的项目？"
  - [ ] 网页应用 (Web Application)
  - [ ] API / 后端服务 (Backend / API)
  - [ ] 移动应用 (Mobile App)
  - [ ] 命令行工具 (CLI)
  - [ ] 其他

**问题 2: 应用领域**（检测 domain）
- "这个项目涉及哪个领域？"
  - [ ] 医疗健康 (Healthcare)
  - [ ] 金融科技 (Fintech)
  - [ ] 电商 (E-Commerce)
  - [ ] 一般业务 (General)
  - [ ] 其他

**问题 3: 项目背景**（检测 projectContext）
- "这是全新项目还是现有系统的扩展？"
  - [ ] 全新项目 (Greenfield)
  - [ ] 现有系统的扩展 (Brownfield)

**问题 4: 复杂度初步评估**（检测 complexity）
- "基于以上信息，您认为项目复杂度如何？"
  - [ ] 小型（单个模块，无或少外部依赖）
  - [ ] 中型（3-5 个模块，中等依赖）
  - [ ] 大型（6+ 个模块，多个复杂依赖）

根据 domain 追加领域特定问题（见本文档下方"**领域感知提问规则**"）。

### 1.3 分类确认

**向用户展示推断的分类**：

```
我理解您的项目是:
- 类型: {{projectType}}
- 领域: {{domain}}
- 背景: {{projectContext}}
- 复杂度: {{complexity}}

这个分类对吗？
```

用户确认或更正。

### 1.4 Phase 1 检查点

所有提问完成后，展示：

```
现在我已理解您的项目分类。

**选择操作**:
[R] Refine - 调整分类或补充更多上下文信息
[C] Continue - 进入 Phase 2：成功标准与范围定义
```

当用户选 C 时，保存 phase1 到 frontmatter：`stepsCompleted: [..., "phase1"]`

---

## Phase 2: 成功标准与范围定义

### 2.1 成功标准（SMART 标准）

**问题系列：定义项目成功的标志是什么？**

对于每个维度，引导用户定义 SMART 的目标：

**业务成功标准**：
- "这个项目的业务目标是什么？期望带来什么商业价值？"
- 引导用户说出可测量的指标（如用户增长、收入提升、成本降低）
- 反模式检查：避免"增加用户粘性"这样的模糊描述 → 改为"将周活提升 30%"

**用户成功标准**：
- "用户使用这个功能时，成功的标志是什么？"
- 引导定义用户能完成的关键操作、所需体验质量
- 例：不说"容易使用"，改为"用户能在 2 分钟内完成首次配置"

**技术成功标准**：
- "从技术角度，这个项目需要满足什么？"
- 诱导用户提及性能、可靠性、集成要求等
- 例：不说"系统稳定"，改为"系统可用性 99.9%，响应延迟 <200ms"

### 2.2 MVP 范围划分

**问题系列：什么是必须在 Phase 1 完成的能力？**

- "如果你必须在 1 个月内完成最小化可用版本，哪些功能绝对不能少？"
- 列出 MVP 功能
- "这些功能之外，还有哪些是后续迭代的？"
- 列出 Phase 2 / Phase 3 功能

**对于 Brownfield 项目**：
- "这个功能会改变现有系统的哪些部分？"
- "现有系统需要升级或兼容改动吗？"
- 记录受影响的模块、迁移策略、向后兼容性要求

### 2.3 Phase 2 检查点

所有成功标准和范围定义完成后，展示：

```
**成功标准总结**：
- 业务: {{业务目标}}
- 用户: {{用户目标}}
- 技术: {{技术目标}}

**范围**:
- MVP: {{MVP 功能}}
- Phase 2: {{扩展功能}}

**选择操作**:
[R] Refine - 调整标准或重新定义范围
[C] Continue - 进入 Phase 3：需求综合
```

当用户选 C 时，保存 phase2 到 frontmatter

---

## Phase 3: 需求综合

### 3.1 用户旅程映射

基于成功标准和 MVP 范围，映射关键用户旅程：

**问题系列**：
- "用户完成 [MVP 功能] 的主要操作路径是什么？"
- 对每个 MVP 功能引导用户描述步骤
- 记录关键决策点、失败路径、异常处理

**格式**：
```markdown
## 用户旅程: [旅程名称]

**场景**: [初始状态]

**步骤**:
1. 用户 [操作] → 系统 [响应]
2. 用户 [操作] → 系统 [响应]
3. ...

**成功结果**: [最终状态]
**失败处理**: [异常情况]
```

### 3.2 功能需求（FRs）- WHAT not HOW

**关键原则**（见下文"**信息密度要求**"）：
- ✅ 能力层面："用户可以..." / "系统支持..."
- ❌ 不用实现细节："使用 JWT token..." / "通过 Redis 缓存..."

从用户旅程和成功标准中提取功能需求：

**问题系列**：
- 从每个旅程步骤逆推"用户/系统需要什么能力？"
- "完成 [MVP 功能] 需要系统具备哪些能力？"
- 组织成逻辑能力域（如"用户管理"、"数据同步"、"报告生成"）

**格式**：
```markdown
## 功能需求

### [能力域名]

- FR-001: [角色] 可以 [执行的操作/系统可以支持的能力]
- FR-002: ...

### [另一能力域]

- FR-003: ...
```

### 3.3 非功能需求（NFRs）- 必须可测量

**关键原则**（见下文"**信息密度要求**"）：
- ✅ 可测量："API 响应 <200ms (95th percentile)"
- ❌ 模糊："系统应该快"

**提问维度**：

**性能**：
- "响应时间要求？"→ 改为"用户在什么时间范围内期望得到反馈？"
- "吞吐量要求？"→ 改为"系统需要同时支持多少用户/请求？"

**可靠性**：
- "可用性要求？"→ "系统允许多长时间的故障/维护？"（99.9%, 99.99% 等）
- "数据完整性？"→ "业务关键数据是否允许丢失？"

**安全性**：
- "身份认证"→ "用户如何验证身份？"
- "数据保护"→ "敏感数据应如何加密和隐藏？"
- 根据 domain 追加领域合规要求

**兼容性**（如适用）：
- "浏览器/操作系统要求？"
- "向后兼容性要求？"

**格式**：
```markdown
## 非功能需求

### 性能
- NFR-P01: API 响应延迟 <200ms (95th percentile, 正常负载)
- NFR-P02: 系统支持 {{用户数}} 并发用户

### 可靠性
- NFR-R01: 系统可用性 {{百分比}} (测量基准: {{检测方法}})

### 安全
- NFR-S01: 身份认证使用 {{方法}}
- NFR-S02: 数据加密 {{算法}}

### [领域] 合规
- NFR-C01: {{合规要求}}
```

### 3.4 自验证 Checklist（内部执行）

**在展示需求给用户前，Agent 内部执行此检查**：

```
✓ 完整性检查
  - [ ] 每个 MVP 功能都对应至少一个 FR？
  - [ ] 每个关键用户旅程的主路径都覆盖了？
  - [ ] 失败路径/异常情况都提到了吗？
  - [ ] 是否需要 [domain] 特定的合规需求？
    (healthcare → HIPAA, fintech → PCI-DSS, 等)

✓ 质量检查
  - [ ] 所有 FRs 是能力描述（WHAT），无实现细节（HOW）？
  - [ ] 所有 NFRs 有明确的数字指标？
  - [ ] 无废话词汇（easy/fast/intuitive/scalable）？
  - [ ] 每个需求可独立验证测试？

✓ 追溯性检查
  - [ ] 每个 FR 能追溯到哪个用户旅程？
  - [ ] 每个旅程能追溯到哪个成功标准？
  - [ ] 能否从目标反推出所有 FRs？
```

**如果检查有失败项，Agent 自我修正后再展示**

### 3.5 Phase 3 检查点

所有需求定义完成后，展示：

```
**用户旅程**：[数量] 个已映射

**功能需求**：[数量] 个 FRs，分 [数量] 个能力域

**非功能需求**：
- 性能: [指标]
- 可靠性: [指标]
- 安全: [指标]
- {{domain}}: [合规要求]

**选择操作**:
[R] Refine - 调整需求或补充缺失项
[C] Continue - 进入 Phase 4：最后确认
```

当用户选 C 时，保存 phase3 到 frontmatter

---

## Phase 4: 最终确认与下一步

### 4.1 复杂度最终评估

基于实际收集的需求，重新评估项目复杂度（可能与 Phase 1 的初步评估不同）：

| 指标 | 小型 | 中型 | 大型 |
|------|------|------|------|
| 模块/能力域数 | 1-2 | 3-5 | 6+ |
| 外部系统集成 | 0-1 | 2-3 | 4+ |
| 状态机复杂度 | 简单线性 | 多状态机 | 复杂分支流 |
| 新技术风险 | 低 | 中 | 高 |
| FR 数量 | <20 | 20-50 | 50+ |

### 4.2 下一步推荐

**根据最终复杂度**：

```
项目规模评估: {{complexity}}

**推荐下一步**:

if 复杂度 == "小型":
  → 直接执行 `/plan` 拆解成 Story

if 复杂度 == "中型":
  → 可选执行 `/architecture` 生成 Spec（建议）
  → 或直接 `/plan` 拆解成 Story

if 复杂度 == "大型":
  → 强烈建议执行 `/architecture` 生成 Spec 体系
  → 然后 `/plan` 拆解成 Story
  → 也可执行 `/roadmap` 规划整体阶段
```

### 4.3 写入文件

**展示完整 PRD 给用户最终确认**

用户确认后，写入 `docs/plans/prd-<feature>.md`，包含完整 frontmatter

---

## 信息密度要求（BMAD 哲学）

### 反模式（禁用词汇与表达）

❌ **避免**：

- "The system will..." → ✅ 改为直接陈述或"系统支持..."
- "易于使用" / "easy to use" → ✅ 改为具体行为"用户可在 X 分钟内完成..."
- "快速" / "fast" → ✅ 改为"<200ms 响应"
- "直观" / "intuitive" → ✅ 改为"通过 [UI 元素] 用户可快速学习"
- "重要的是" / "It is important to note that" → ✅ 直接陈述事实
- "尽可能" / "as much as possible" → ✅ 定量需求

### 功能需求 (FRs) 写作标准

**WHAT not HOW**：

❌ 实现细节（HOW）：
```
"用户通过发送 JWT token 到 /api/auth 端点来认证，token 24 小时过期"
```

✅ 能力描述（WHAT）：
```
"用户可以使用密码进行身份认证"
```

❌ UI 特定：
```
"用户点击右上角的蓝色按钮打开菜单"
```

✅ 用户能力：
```
"用户可以访问主菜单"
```

**格式标准**：
- `[角色] 可以 [动作] [上下文/约束]`
- 例：`"管理员可以批量导出用户数据（限制：仅可导出该管理员所属机构的数据）"`

### 非功能需求 (NFRs) 写作标准

**必须可测量**，包含三要素：指标 + 测量方法 + 条件

❌ 模糊：
```
"系统应该快"
"系统应该可靠"
"确保数据安全"
```

✅ 可测量：
```
"API 响应延迟 <200ms (95th percentile, 正常业务负载下，通过 APM 监测)"
"系统可用性 99.9% (按月计算，基准：监控告警)"
"用户数据加密存储 (AES-256)，传输加密 (TLS 1.3)"
```

---

## 领域感知提问规则（内嵌）

### Healthcare（医疗健康）- 复杂度自动标记为 HIGH

**关键问题**：
1. "这个系统是否处理受保护健康信息（PHI）？"
   - 是 → 触发 HIPAA 完整要求
   - 否 → 仍需基础医疗行业规范

2. "HIPAA 合规范围？"
   - 需要患者隐私保护 / 数据加密 / 审计日志

3. "是否涉及临床决策？"
   - 是 → FDA 验证可能相关

4. "数据保留策略？"
   - 患者数据多久清除？法规要求？

**强制要求**：
- [ ] HIPAA 合规性说明
- [ ] 数据加密方案（AES-256 等）
- [ ] 审计日志要求（谁、何时、操作什么）
- [ ] 多因素认证方式

### Fintech（金融科技）- 复杂度自动标记为 HIGH

**关键问题**：
1. "是否处理支付或存储卡数据？"
   - 是 → 触发 PCI-DSS 完整要求
   - 否 → 仍需 KYC/AML 合规检查

2. "覆盖的司法辖区？"
   - 不同地区有不同监管要求
   - 记录每个地区的合规要求

3. "KYC/反洗钱流程？"
   - 用户验证方式？
   - 可疑交易检测？

4. "交易原子性要求？"
   - 交易幂等性？
   - 失败恢复策略？

**强制要求**：
- [ ] PCI-DSS 合规说明（如处理卡数据）
- [ ] KYC/AML 流程描述
- [ ] 地区合规矩阵
- [ ] 交易安全机制

### E-Commerce（电商）- 复杂度自动标记为 MEDIUM

**关键问题**：
1. "支持的支付方式？"
   - 信用卡 / 电子钱包 / 银行转账？
   - 第三方支付集成（Stripe / PayPal 等）？

2. "运营的司法辖区（国家/地区）？"
   - 税务计算复杂度
   - 本地支付方式支持

3. "退货/退款流程？"
   - 标准流程是什么？
   - 争议处理机制？

**强制要求**：
- [ ] 支付方式清单
- [ ] 税务计算策略（按地区）
- [ ] 退货政策
- [ ] 退款处理时间

### General（一般业务）- 默认 LOW-MEDIUM 复杂度

**标准问题**：
- 用户认证方式（本地/OAuth/SSO）？
- 数据备份和灾恢策略？
- 多语言/多时区支持？

---

## PRD 格式（新增 Frontmatter）

### 完整的 PRD 模板

```yaml
---
# 工作流状态
created: 2026-02-13
updated: 2026-02-13
status: draft | in-progress | complete
stepsCompleted: ["phase1", "phase2", "phase3", "phase4"]

# 项目分类（由 Phase 1 填充）
classification:
  projectType: "web_app"
  domain: "healthcare"
  complexity: "high"
  projectContext: "greenfield"

# 输入文档溯源（Phase 0 记录）
inputDocuments:
  - spec/0_project/project-spec.md
  - README.md
---

# PRD: [功能名称]

**作者**: {{user_name}}
**日期**: {{created}}
**状态**: {{status}}
**最后更新**: {{updated}}

---

## 概述

[一句话核心价值描述]

**目标用户**: [用户角色/画像]
**核心问题**: [解决什么问题]
**差异化**: [与现有方案的区别]

---

## 成功标准

### 业务成功
- {{具体、可测量的业务指标}}

### 用户成功
- {{用户能力、完成时间等}}

### 技术成功
- {{性能、可靠性等指标}}

---

## 产品范围

### MVP（Phase 1 - 必须交付）
- [ ] {{功能}}
- [ ] {{功能}}

### Growth（Phase 2 - 应该包含）
- [ ] {{功能}}

### Vision（Phase 3+ - 可能包含）
- [ ] {{功能}}

### 明确不在范围内
- {{排除项}}

{{if brownfield}}
### Brownfield 影响分析
**涉及的现有模块**:
- {{模块}}

**兼容性策略**:
- {{迁移/兼容方案}}
{{endif}}

---

## 用户旅程

### 旅程 1: [名称]

**场景**: [初始状态]

**步骤**:
1. {{用户操作}} → {{系统响应}}
2. ...

**成功结果**: [最终状态]
**失败处理**: [异常处理]

---

{{if domain != "general"}}
## {{domain}} 领域要求

{{根据 domain 的强制要求填充}}

---
{{endif}}

## 功能需求

### [能力域 1 名称]

- FR-001: [角色] 可以 [操作/能力]
- FR-002: ...

### [能力域 2 名称]

- FR-003: ...

---

## 非功能需求

### 性能
- NFR-P01: {{指标}} ({{测量方法}})

### 可靠性
- NFR-R01: {{指标}} ({{测量方法}})

### 安全
- NFR-S01: {{认证方式}}
- NFR-S02: {{数据保护}}

### {{domain}} 合规
- NFR-C01: {{合规要求}}

---

## 约束与假设

### 技术约束
- ...

### 业务约束
- ...

### 依赖
- 外部系统: ...
- 第三方服务: ...

---

## 开放问题

- [ ] {{待确认的问题}}

---

## Appendix

### 术语表
### 参考文档
```

---

## 完成后

用户确认 PRD 后，提示下一步：

**小型项目** (complexity: low)
→ 建议直接执行 `/plan` 拆解成 Epic → Story

**中型项目** (complexity: medium)
→ 可选执行 `/architecture` 生成 Spec（推荐）
→ 或直接 `/plan`

**大型项目** (complexity: high)
→ 强烈建议执行 `/architecture` 生成 Spec 体系
→ 然后执行 `/plan` 拆解成 Story
→ 可选执行 `/roadmap` 规划阶段
