---
name: systematic-debugging
description: 四阶段系统化调试（根因调查 → 模式分析 → 假设验证 → 实施修复）。3 次失败触发架构讨论。
triggers:
  - /bugfix
  - 测试失败
  - 生产 bug
---

# 系统化调试 (Systematic Debugging)

## 概述

随机修复浪费时间并引入新 bug。快速补丁掩盖根本问题。

**核心原则**：修复之前，必须先找到根因。症状修复 = 失败。

## Iron Law

```
没有根因调查，就不能提出修复方案
```

没完成阶段 1，就不能开始修复。

## 适用场景

用于所有技术问题：
- 测试失败
- 生产 bug
- 意外行为
- 性能问题
- 构建失败
- 集成问题

**特别是在这些时候**：
- 时间紧迫（越急越不能猜）
- "就改一下试试"的念头出现时
- 已经尝试了多次修复没成功
- 你不完全理解问题

## 四个阶段

必须按顺序完成每个阶段。

### 阶段 1：根因调查

**在尝试任何修复之前：**

1. **仔细阅读错误信息**
   - 不要跳过错误和警告
   - 完整阅读 stack trace
   - 记录行号、文件路径、错误码

2. **稳定复现**
   - 能可靠触发吗？
   - 精确的复现步骤是什么？
   - 每次都能复现吗？
   - 无法复现 → 收集更多数据，不要猜

3. **检查最近变更**
   - 什么改动可能导致了这个问题？
   - git diff、最近的 commit
   - 新依赖、配置变更、环境差异

4. **多组件系统：收集证据**

   当系统有多个组件时，**在提出修复前**，给每个组件边界加诊断信息：

   ```
   对每个组件边界：
     - 记录进入组件的数据
     - 记录离开组件的数据
     - 验证环境/配置传递
     - 检查每层状态

   运行一次收集证据 → 分析证据找到断裂点 → 调查该组件
   ```

5. **追踪数据流**
   - 错误值从哪里来？
   - 谁用错误值调用了这里？
   - 持续向上追踪直到找到源头
   - 在源头修复，不在症状处修复

### 阶段 2：模式分析

1. **找到可工作的示例**
   - 代码库中有类似的、能正常工作的代码吗？

2. **对比参考实现**
   - 如果在实现某个模式，**完整阅读**参考实现
   - 不要略读

3. **找出差异**
   - 工作版本和失败版本有什么不同？
   - 列出所有差异，无论多小
   - 不要假设"那个不可能有影响"

4. **理解依赖**
   - 需要哪些其他组件？
   - 什么设置、配置、环境？

### 阶段 3：假设与验证

1. **形成假设**
   - 明确陈述："我认为 X 是根因，因为 Y"
   - 具体，不模糊

2. **最小验证**
   - 做最小的改动来验证假设
   - 一次只改一个变量
   - 不要同时修多个问题

3. **验证后再继续**
   - 成功？→ 进入阶段 4
   - 失败？→ 形成新假设
   - 不要在上面叠加更多修复

### 阶段 4：实施修复

1. **创建失败测试**
   - 最简单的复现
   - 自动化测试优先
   - 修复前必须有测试

2. **单一修复**
   - 针对已确认的根因
   - 一次只改一个地方
   - 不搞"顺手改进"

3. **验证修复**
   - 测试通过了吗？
   - 其他测试没坏吧？
   - 问题真的解决了吗？

4. **修复失败时**
   - 停下来，数一数尝试了几次
   - < 3 次：回到阶段 1，用新信息重新分析
   - **≥ 3 次：停下来，质疑架构**
   - 不要在没有架构讨论的情况下尝试第 4 次修复

5. **3 次修复失败 = 架构问题**

   **模式识别**：
   - 每次修复揭示新的耦合/共享状态问题
   - 修复需要"大规模重构"
   - 每次修复在别处产生新症状

   **停下来质疑根本**：
   - 这个模式/架构从根本上合理吗？
   - 是不是因为惯性在坚持？
   - 应该重构架构还是继续修症状？

   **与用户讨论后再继续**

## 红旗 — 停下来回到阶段 1

如果你发现自己在想：
- "先快速修一下，之后再查"
- "试试改 X 看看行不行"
- "同时改几个地方，跑一下测试"
- "我大概知道，试试这个"
- "再试一次修复"（已经试了 2+ 次）

**全部意味着：停下来，回到阶段 1。**

## 快速参考

| 阶段 | 关键活动 | 成功标准 |
|------|---------|---------|
| **1. 根因** | 读错误、复现、查变更、收集证据 | 理解了 WHAT 和 WHY |
| **2. 模式** | 找工作示例、对比 | 找到差异 |
| **3. 假设** | 形成理论、最小验证 | 确认或新假设 |
| **4. 实施** | 写测试、修复、验证 | Bug 解决，测试通过 |
